# 核心数据模型

<cite>
**本文档中引用的文件**
- [agentlightning/types/core.py](file://agentlightning/types/core.py)
- [agentlightning/adapter/triplet.py](file://agentlightning/adapter/triplet.py)
- [agentlightning/types/resources.py](file://agentlightning/types/resources.py)
- [agentlightning/types/tracer.py](file://agentlightning/types/tracer.py)
- [agentlightning/store/base.py](file://agentlightning/store/base.py)
- [agentlightning/store/memory.py](file://agentlightning/store/memory.py)
- [agentlightning/store/utils.py](file://agentlightning/store/utils.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构概览](#项目结构概览)
3. [核心数据模型](#核心数据模型)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介

Agent Lightning是一个用于强化学习训练的分布式系统，其核心数据模型设计围绕着Rollout、Triplet、Attempt和Task等关键实体构建。这些模型不仅定义了系统的数据结构，还实现了复杂的状态转换逻辑和资源版本管理机制。本文档将深入分析这些核心数据模型的设计理念、实现细节和相互关系。

## 项目结构概览

Agent Lightning采用模块化架构，核心数据模型分布在以下关键模块中：

```mermaid
graph TB
subgraph "核心类型模块"
CoreTypes["types/core.py<br/>核心数据模型"]
ResourceTypes["types/resources.py<br/>资源类型"]
TracerTypes["types/tracer.py<br/>追踪类型"]
end
subgraph "适配器模块"
TripletAdapter["adapter/triplet.py<br/>三元组适配器"]
BaseAdapter["adapter/base.py<br/>基础适配器"]
end
subgraph "存储模块"
StoreBase["store/base.py<br/>存储接口"]
MemoryStore["store/memory.py<br/>内存存储"]
ThreadedStore["store/threading.py<br/>线程安全存储"]
end
CoreTypes --> TripletAdapter
ResourceTypes --> StoreBase
TracerTypes --> TripletAdapter
StoreBase --> MemoryStore
StoreBase --> ThreadedStore
```

**图表来源**
- [agentlightning/types/core.py](file://agentlightning/types/core.py#L1-L50)
- [agentlightning/adapter/triplet.py](file://agentlightning/adapter/triplet.py#L1-L50)
- [agentlightning/store/base.py](file://agentlightning/store/base.py#L1-L50)

## 核心数据模型

### Triplet（三元组）模型

Triplet是强化学习中的基本交互单元，表示单次对话或推理过程的完整轨迹。

```mermaid
classDiagram
class Triplet {
+Any prompt
+Any response
+Optional~float~ reward
+Dict~str,Any~ metadata
+__init__(prompt, response, reward, metadata)
}
class Transition {
+int[] state
+int[] action
+Optional~str~ response_id
+str agent_name
+Optional~float~ reward
}
Triplet --> Transition : "包含"
```

**图表来源**
- [agentlightning/types/core.py](file://agentlightning/types/core.py#L50-L60)
- [agentlightning/adapter/triplet.py](file://agentlightning/adapter/triplet.py#L20-L35)

**字段含义：**
- `prompt`: 模型输入的令牌标识符列表
- `response`: 模型输出的令牌标识符列表
- `reward`: 关联的标量奖励值（可选）
- `metadata`: 包含响应ID和代理名称等附加信息的字典

### Rollout（执行轮次）模型

Rollout代表一次完整的任务执行尝试，包含了从开始到结束的整个生命周期。

```mermaid
classDiagram
class Rollout {
+str rollout_id
+TaskInput input
+float start_time
+Optional~float~ end_time
+Optional~str~ mode
+Optional~str~ resources_id
+RolloutStatus status
+RolloutConfig config
+Optional~Dict~str,Any~~ metadata
+validate_input()
+update_status()
}
class AttemptedRollout {
+Attempt attempt
+check_consistency()
}
class RolloutConfig {
+Optional~float~ timeout_seconds
+Optional~float~ unresponsive_seconds
+int max_attempts
+AttemptStatus[] retry_condition
}
Rollout <|-- AttemptedRollout
Rollout --> RolloutConfig : "配置"
```

**图表来源**
- [agentlightning/types/core.py](file://agentlightning/types/core.py#L120-L180)

**状态转换逻辑：**
- `queuing` → `preparing` → `running` → `{succeeded, failed, cancelled}`
- 支持重试机制，根据配置的条件决定是否重新排队

### Attempt（尝试）模型

Attempt表示Rollout的一次具体执行尝试，包含详细的元数据和状态信息。

```mermaid
classDiagram
class Attempt {
+str rollout_id
+str attempt_id
+int sequence_id
+float start_time
+Optional~float~ end_time
+AttemptStatus status
+Optional~str~ worker_id
+Optional~float~ last_heartbeat_time
+Optional~Dict~str,Any~~ metadata
}
class AttemptStatus {
<<enumeration>>
preparing
running
failed
succeeded
unresponsive
timeout
}
Attempt --> AttemptStatus : "状态"
```

**图表来源**
- [agentlightning/types/core.py](file://agentlightning/types/core.py#L90-L120)

### Task（任务）模型

Task是传递给客户端代理的执行请求，承载了任务的具体输入和上下文信息。

```mermaid
classDiagram
class Task {
+str rollout_id
+TaskInput input
+Optional~str~ mode
+Optional~str~ resources_id
+Optional~float~ create_time
+Optional~float~ last_claim_time
+Optional~int~ num_claims
+Dict~str,Any~ metadata
}
class TaskInput {
<<type>>
Any
}
Task --> TaskInput : "输入"
```

**图表来源**
- [agentlightning/types/core.py](file://agentlightning/types/core.py#L180-L210)

**节来源**
- [agentlightning/types/core.py](file://agentlightning/types/core.py#L50-L210)

## 架构概览

Agent Lightning的核心数据模型遵循分层架构设计，确保了良好的可扩展性和维护性：

```mermaid
graph TB
subgraph "应用层"
Agent[LitAgent]
Runner[Runner]
end
subgraph "控制平面"
Store[LightningStore]
Manager[RolloutManager]
end
subgraph "数据层"
RolloutModels["Rollout, Attempt, Task"]
TripletModels["Triplet, Transition"]
ResourceModels["LLM, PromptTemplate"]
TraceModels["Span, Event"]
end
subgraph "持久化层"
MemoryStore[InMemoryStore]
SQLiteStore[SQLiteStore]
ClientServer[ClientServerStore]
end
Agent --> Store
Runner --> Store
Store --> Manager
Manager --> RolloutModels
Manager --> TripletModels
Manager --> ResourceModels
Manager --> TraceModels
Store --> MemoryStore
Store --> SQLiteStore
Store --> ClientServer
```

**图表来源**
- [agentlightning/store/base.py](file://agentlightning/store/base.py#L50-L100)
- [agentlightning/types/core.py](file://agentlightning/types/core.py#L1-L50)

## 详细组件分析

### 资源管理系统

资源管理系统负责管理可调优的资源，如LLM端点、提示模板等。

```mermaid
classDiagram
class Resource {
+Any resource_type
}
class LLM {
+Literal~"llm"~ resource_type
+str endpoint
+str model
+Optional~str~ api_key
+Dict~str,Any~ sampling_parameters
+get_base_url()
}
class ProxyLLM {
+Literal~"proxy_llm"~ resource_type
+bool _initialized
+with_attempted_rollout()
+get_base_url()
+model_post_init()
}
class PromptTemplate {
+Literal~"prompt_template"~ resource_type
+str template
+Literal engine
+format()
}
class ResourcesUpdate {
+str resources_id
+NamedResources resources
}
Resource <|-- LLM
LLM <|-- ProxyLLM
Resource <|-- PromptTemplate
ResourcesUpdate --> NamedResources : "包含"
```

**图表来源**
- [agentlightning/types/resources.py](file://agentlightning/types/resources.py#L30-L150)

**资源版本管理机制：**
- 使用不可变快照确保资源的一致性
- 支持通过`resources_id`进行版本控制
- 提供`add_resources()`和`update_resources()`方法

### 追踪系统

追踪系统捕获和管理执行过程中的所有操作记录。

```mermaid
classDiagram
class Span {
+str rollout_id
+str attempt_id
+int sequence_id
+str trace_id
+str span_id
+Optional~str~ parent_id
+str name
+TraceStatus status
+Attributes attributes
+Event[] events
+Link[] links
+Optional~float~ start_time
+Optional~float~ end_time
+from_opentelemetry()
+from_attributes()
}
class TraceStatus {
+str status_code
+Optional~str~ description
}
class Event {
+str name
+Attributes attributes
+Optional~float~ timestamp
}
class SpanContext {
+str trace_id
+str span_id
+bool is_remote
+TraceState trace_state
}
Span --> TraceStatus : "状态"
Span --> Event : "事件"
Span --> SpanContext : "上下文"
```

**图表来源**
- [agentlightning/types/tracer.py](file://agentlightning/types/tracer.py#L200-L350)

### 三元组转换器

三元组转换器负责将原始追踪数据转换为强化学习可用的轨迹格式。

```mermaid
sequenceDiagram
participant Trace as "原始追踪"
participant Tree as "TraceTree"
participant Adapter as "适配器"
participant Triplet as "Triplet"
Trace->>Tree : 构建树结构
Tree->>Tree : 修复层次结构
Tree->>Tree : 查找LLM调用
Tree->>Tree : 匹配奖励
Tree->>Adapter : 转换为轨迹
Adapter->>Triplet : 创建三元组
Triplet-->>Adapter : 返回结果
```

**图表来源**
- [agentlightning/adapter/triplet.py](file://agentlightning/adapter/triplet.py#L400-L600)

**节来源**
- [agentlightning/types/resources.py](file://agentlightning/types/resources.py#L30-L199)
- [agentlightning/types/tracer.py](file://agentlightning/types/tracer.py#L200-L427)
- [agentlightning/adapter/triplet.py](file://agentlightning/adapter/triplet.py#L400-L879)

## 依赖关系分析

核心数据模型之间存在复杂的依赖关系，形成了清晰的层次结构：

```mermaid
graph TD
subgraph "基础模型层"
BaseModel[Pydantic BaseModel]
Triplet[Triplet]
Span[Span]
end
subgraph "业务模型层"
Rollout[Rollout]
Attempt[Attempt]
Task[Task]
Resource[Resource]
end
subgraph "管理层"
LightningStore[LightningStore]
StoreUtils[Store Utils]
Propagator[Status Propagator]
end
BaseModel --> Triplet
BaseModel --> Span
BaseModel --> Rollout
BaseModel --> Attempt
BaseModel --> Task
BaseModel --> Resource
Rollout --> Attempt
Attempt --> Span
LightningStore --> Rollout
LightningStore --> Attempt
LightningStore --> Span
LightningStore --> Resource
StoreUtils --> Propagator
Propagator --> Rollout
Propagator --> Attempt
```

**图表来源**
- [agentlightning/store/base.py](file://agentlightning/store/base.py#L1-L50)
- [agentlightning/store/utils.py](file://agentlightning/store/utils.py#L1-L30)

**节来源**
- [agentlightning/store/base.py](file://agentlightning/store/base.py#L1-L516)

## 性能考虑

### 序列化/反序列化优化

系统采用多种策略优化Pydantic模型的序列化性能：

1. **延迟加载**：仅在需要时解析复杂对象
2. **缓存机制**：缓存频繁访问的模型实例
3. **批量处理**：支持批量序列化减少开销

### 内存管理

- 使用弱引用避免循环引用
- 实现对象池减少GC压力
- 支持流式处理大型数据集

### 并发安全

- 原子操作确保状态一致性
- 读写锁优化并发访问
- 无锁数据结构提升性能

## 故障排除指南

### 常见验证错误

**Rollout ID不一致错误：**
```python
# 错误场景
attempt.rollout_id != rollout.rollout_id

# 解决方案
# 确保Attempt和Rollout使用相同的rollout_id
```

**状态转换无效错误：**
```python
# 错误场景
attempt.status = "invalid_status"

# 解决方案
# 使用预定义的状态枚举
from agentlightning.types import AttemptStatus
attempt.status = AttemptStatus.running
```

### 数据完整性检查

系统提供了健康检查机制来验证数据完整性：

```python
# 自动健康检查
await healthcheck([rollout], update_rollout_mock, update_attempt_mock)
```

**节来源**
- [agentlightning/store/utils.py](file://agentlightning/store/utils.py#L1-L29)
- [agentlightning/store/memory.py](file://agentlightning/store/memory.py#L845-L907)

## 结论

Agent Lightning的核心数据模型设计体现了现代软件架构的最佳实践：

1. **类型安全**：使用Pydantic确保数据验证和类型安全
2. **状态管理**：清晰的状态转换逻辑支持复杂的业务流程
3. **扩展性**：模块化设计便于功能扩展和定制
4. **性能优化**：多层次的优化策略确保系统高效运行
5. **向后兼容**：精心设计的版本管理机制保证系统稳定性

这些核心数据模型不仅支撑了Agent Lightning的强大功能，也为构建类似的强化学习系统提供了宝贵的参考。通过深入理解这些模型的设计理念和实现细节，开发者可以更好地利用Agent Lightning的强大能力，构建高质量的强化学习应用。