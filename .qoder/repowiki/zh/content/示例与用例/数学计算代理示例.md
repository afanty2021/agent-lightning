# 数学计算代理示例

<cite>
**本文档中引用的文件**
- [examples/calc_x/README.md](file://examples/calc_x/README.md)
- [examples/calc_x/calc_agent.py](file://examples/calc_x/calc_agent.py)
- [examples/calc_x/train_calc_agent.py](file://examples/calc_x/train_calc_agent.py)
- [examples/calc_x/eval_utils.py](file://examples/calc_x/eval_utils.py)
- [examples/calc_x/legacy_calc_agent.py](file://examples/calc_x/legacy_calc_agent.py)
- [examples/calc_x/tests/test_mcp_calculator.py](file://examples/calc_x/tests/test_mcp_calculator.py)
- [examples/calc_x/tests/test_agentops.py](file://examples/calc_x/tests/test_agentops.py)
- [examples/calc_x/legacy_calc_agent_debug.py](file://examples/calc_x/legacy_calc_agent_debug.py)
- [examples/calc_x/legacy_train.sh](file://examples/calc_x/legacy_train.sh)
- [agentlightning/trainer/trainer.py](file://agentlightning/trainer/trainer.py)
- [agentlightning/litagent/litagent.py](file://agentlightning/litagent/litagent.py)
- [agentlightning/emitter/reward.py](file://agentlightning/emitter/reward.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [训练流程](#训练流程)
7. [性能评估](#性能评估)
8. [部署指南](#部署指南)
9. [故障排除](#故障排除)
10. [总结](#总结)

## 简介

数学计算代理（Calc-X）示例是Agent Lightning框架的一个重要演示项目，展示了如何使用强化学习技术训练数学推理代理。该项目基于VERL算法和AutoGen框架，通过模型上下文协议（MCP）访问计算器工具来解决数学问题。

### 主要特性

- **零代码变更优化**：通过Agent Lightning框架对数学推理代理进行优化
- **MCP集成**：与计算器服务器的无缝集成
- **强化学习训练**：使用VERL算法进行端到端训练
- **多版本兼容**：支持新旧两种API版本
- **性能监控**：集成AgentOps和LiteLLM进行跟踪

## 项目结构

```mermaid
graph TD
A[examples/calc_x/] --> B[calc_agent.py]
A --> C[train_calc_agent.py]
A --> D[eval_utils.py]
A --> E[legacy_calc_agent.py]
A --> F[tests/]
A --> G[data/]
F --> H[test_mcp_calculator.py]
F --> I[test_agentops.py]
B --> J[MCP计算器集成]
B --> K[AutoGen助手代理]
B --> L[奖励评估]
C --> M[VERL算法配置]
C --> N[分布式训练]
C --> O[超参数管理]
D --> P[数学结果比较]
D --> Q[精度评估]
```

**图表来源**
- [examples/calc_x/calc_agent.py](file://examples/calc_x/calc_agent.py#L1-L159)
- [examples/calc_x/train_calc_agent.py](file://examples/calc_x/train_calc_agent.py#L1-L233)
- [examples/calc_x/eval_utils.py](file://examples/calc_x/eval_utils.py#L1-L70)

**章节来源**
- [examples/calc_x/README.md](file://examples/calc_x/README.md#L1-L75)

## 核心组件

### 数学问题定义

项目使用`MathProblem`类型定义数学问题的数据结构：

```python
class MathProblem(TypedDict):
    id: str          # 问题ID
    question: str    # 数学问题描述
    chain: str       # 解题步骤（训练时不使用）
    result: str      # 真实答案
    source: str      # 数据源
```

### 代理架构

```mermaid
classDiagram
class CalcAgent {
+rollout(task, llm) None
+autogen_assistant_agent() AssistantAgent
-evaluate_answer() float
}
class MathProblem {
+id : str
+question : str
+result : str
+source : str
}
class McpWorkbench {
+calculator_mcp_server : StdioServerParams
+initialize() AsyncContextManager
}
class AssistantAgent {
+name : str
+model_client : OpenAIChatCompletionClient
+workbench : McpWorkbench
+reflect_on_tool_use : bool
+run(prompt) ChatResult
}
CalcAgent --> MathProblem : 处理
CalcAgent --> McpWorkbench : 使用
CalcAgent --> AssistantAgent : 创建
McpWorkbench --> CalculatorServer : 连接
```

**图表来源**
- [examples/calc_x/calc_agent.py](file://examples/calc_x/calc_agent.py#L15-L159)

**章节来源**
- [examples/calc_x/calc_agent.py](file://examples/calc_x/calc_agent.py#L15-L159)

## 架构概览

数学计算代理采用分层架构设计，包含以下主要层次：

```mermaid
graph TB
subgraph "用户接口层"
A[命令行接口]
B[调试接口]
end
subgraph "代理执行层"
C[CalcAgent]
D[LegacyCalcAgent]
E[LitAgentRunner]
end
subgraph "工具集成层"
F[MCP工作台]
G[计算器服务器]
H[AutoGen助手]
end
subgraph "训练优化层"
I[VERL算法]
J[奖励评估]
K[存储系统]
end
subgraph "基础设施层"
L[Ray集群]
M[LLM代理]
N[追踪系统]
end
A --> C
B --> C
C --> F
F --> G
F --> H
C --> I
I --> J
I --> K
I --> L
I --> M
I --> N
```

**图表来源**
- [examples/calc_x/train_calc_agent.py](file://examples/calc_x/train_calc_agent.py#L41-L233)
- [agentlightning/trainer/trainer.py](file://agentlightning/trainer/trainer.py#L40-L199)

## 详细组件分析

### 计算器MCP集成

项目通过MCP（Model Context Protocol）实现与计算器服务器的集成：

```mermaid
sequenceDiagram
participant Agent as CalcAgent
participant Workbench as McpWorkbench
participant Server as CalculatorServer
participant LLM as OpenAI LLM
Agent->>Workbench : 初始化MCP工作台
Workbench->>Server : 启动计算器服务器
Agent->>LLM : 发送数学问题
LLM->>Agent : 返回工具调用
Agent->>Server : 调用calculate工具
Server-->>Agent : 返回计算结果
Agent->>Agent : 提取答案格式化
Agent->>Agent : 评估奖励
```

**图表来源**
- [examples/calc_x/calc_agent.py](file://examples/calc_x/calc_agent.py#L74-L103)
- [examples/calc_x/tests/test_mcp_calculator.py](file://examples/calc_x/tests/test_mcp_calculator.py#L15-L65)

### 强化学习训练流程

VERL算法的训练流程包含以下关键步骤：

```mermaid
flowchart TD
A[开始训练] --> B[加载数据集]
B --> C[初始化VERL算法]
C --> D[启动Ray集群]
D --> E[创建工作进程]
E --> F[执行代理回放]
F --> G[收集轨迹数据]
G --> H[计算优势函数]
H --> I[更新策略网络]
I --> J{是否完成训练?}
J --> |否| F
J --> |是| K[保存模型]
K --> L[结束]
```

**图表来源**
- [examples/calc_x/train_calc_agent.py](file://examples/calc_x/train_calc_agent.py#L82-L233)

### 奖励评估机制

项目实现了智能的奖励评估系统：

```mermaid
flowchart TD
A[预测答案] --> B{是否为选项答案?}
B --> |是| C[标准化选项]
B --> |否| D[解析数值表达式]
C --> E[比较选项匹配]
D --> F[转换为浮点数]
F --> G{数值接近?}
G --> |是| H[返回1.0奖励]
G --> |否| I[返回0.0奖励]
E --> J{选项匹配?}
J --> |是| H
J --> |否| I
```

**图表来源**
- [examples/calc_x/eval_utils.py](file://examples/calc_x/eval_utils.py#L25-L69)

**章节来源**
- [examples/calc_x/eval_utils.py](file://examples/calc_x/eval_utils.py#L1-L70)

## 训练流程

### 环境配置

训练前需要准备以下环境：

1. **硬件要求**：至少一个40GB GPU的单节点
2. **软件依赖**：
   ```bash
   pip install "autogen-agentchat" "autogen-ext[openai]" "mcp>=1.10.0"
   ```
3. **数据准备**：
   ```bash
   unzip calc-x-data.zip -d data
   ```

### 训练脚本执行

```mermaid
sequenceDiagram
participant User as 用户
participant Script as train_calc_agent.py
participant Ray as Ray集群
participant Workers as 工作进程
participant Store as 存储系统
User->>Script : 执行训练命令
Script->>Ray : 启动Ray集群
Script->>Workers : 启动训练工作进程
Script->>Store : 初始化存储系统
Workers->>Workers : 执行代理回放
Workers->>Store : 存储轨迹数据
Workers->>Script : 汇报训练进度
Script->>User : 显示训练结果
```

**图表来源**
- [examples/calc_x/train_calc_agent.py](file://examples/calc_x/train_calc_agent.py#L82-L233)

### 超参数配置

VERL算法的关键配置参数：

| 参数类别 | 配置项 | 默认值 | 说明 |
|----------|--------|--------|------|
| 算法参数 | adv_estimator | grpo | 优势估计器类型 |
| 算法参数 | use_kl_in_reward | false | 是否在奖励中使用KL散度 |
| 数据参数 | train_batch_size | 32 | 训练批次大小 |
| 数据参数 | max_prompt_length | 4096 | 最大提示长度 |
| 数据参数 | max_response_length | 2048 | 最大响应长度 |
| Actor参数 | ppo_mini_batch_size | 32 | PPO迷你批次大小 |
| Actor参数 | ppo_micro_batch_size_per_gpu | 4 | GPU微批次大小 |
| Actor参数 | lr | 1e-6 | 学习率 |
| 模型参数 | path | Qwen/Qwen2.5-1.5B-Instruct | 基础模型路径 |

**章节来源**
- [examples/calc_x/train_calc_agent.py](file://examples/calc_x/train_calc_agent.py#L41-L80)

## 性能评估

### 评估指标

项目使用多种指标评估代理性能：

1. **准确率**：正确回答的比例
2. **数值精度**：数值计算的准确性
3. **选项匹配**：选择题的选项正确率
4. **推理质量**：解题过程的质量评估

### 评估工具

```mermaid
classDiagram
class EvalUtils {
+normalize_option(option) str
+is_option_result(result) bool
+float_eval(input_str) float
+scalar_are_results_same(pred, true, tol) bool
+evaluate(prediction, ground_truth) float
}
class RewardDecorator {
+reward(fn) FnType
+emit_reward(reward) ReadableSpan
+get_reward_value(span) float
}
EvalUtils --> RewardDecorator : 使用
```

**图表来源**
- [examples/calc_x/eval_utils.py](file://examples/calc_x/eval_utils.py#L10-L70)
- [agentlightning/emitter/reward.py](file://agentlightning/emitter/reward.py#L40-L239)

**章节来源**
- [examples/calc_x/eval_utils.py](file://examples/calc_x/eval_utils.py#L1-L70)

## 部署指南

### 快速开始

1. **安装依赖**：
   ```bash
   pip install agentlightning
   ```

2. **下载数据**：
   ```bash
   unzip calc-x-data.zip -d data
   ```

3. **启动训练**：
   ```bash
   bash ../../scripts/restart_ray.sh
   python train_calc_agent.py --train-file data/train.parquet --val-file data/test.parquet
   ```

### 调试模式

```bash
python calc_agent.py
```

### 实验室版本

对于旧版本兼容性：

```bash
bash legacy_train.sh
python legacy_calc_agent.py
```

**章节来源**
- [examples/calc_x/README.md](file://examples/calc_x/README.md#L40-L75)

## 故障排除

### 常见问题

1. **MCP计算器连接失败**
   - 确保`uvx`和MCP计算器服务器已正确安装
   - 检查环境变量配置
   - 运行测试脚本验证连接

2. **GPU内存不足**
   - 调整`gpu_memory_utilization`参数
   - 减少批次大小或微批次大小
   - 使用梯度检查点

3. **训练不收敛**
   - 检查学习率设置
   - 验证奖励信号质量
   - 调整KL散度系数

### 性能调优建议

1. **内存优化**
   - 启用参数卸载和优化器卸载
   - 使用梯度检查点
   - 调整批次大小

2. **计算优化**
   - 使用张量并行处理
   - 优化GPU内存利用率
   - 并行化训练过程

3. **训练稳定性**
   - 监控KL散度变化
   - 调整裁剪比率
   - 使用适当的奖励缩放

**章节来源**
- [examples/calc_x/README.md](file://examples/calc_x/README.md#L60-L75)

## 总结

数学计算代理示例展示了Agent Lightning框架在强化学习领域的强大能力。通过零代码变更优化、MCP集成和VERL算法，该项目成功实现了数学推理代理的自动化训练。

### 关键优势

1. **零代码变更优化**：无需修改代理代码即可获得性能提升
2. **模块化设计**：清晰的组件分离便于维护和扩展
3. **强大的工具集成**：MCP协议提供了灵活的工具访问机制
4. **完善的评估体系**：多层次的评估确保了训练效果

### 应用前景

该示例为数学教育、智能问答系统和科学计算等领域提供了可参考的解决方案，展示了强化学习在复杂推理任务中的应用潜力。